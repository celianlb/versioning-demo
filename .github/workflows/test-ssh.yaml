name: Test SSH
on: workflow_dispatch

jobs:
  ping:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Write SSH private key from secret (keep newlines)
        shell: bash
        run: |
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > key.pem
          sed -i 's/\r$//' key.pem
          chmod 600 key.pem
          head -n1 key.pem | sed 's/.*/First line OK (masked)/'
          tail -n1 key.pem | sed 's/.*/Last line OK (masked)/'
          grep -q "BEGIN OPENSSH PRIVATE KEY" key.pem || (echo "❌ Mauvais format de clé"; exit 1)

      - name: SSH check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: key.pem
          script: |
            echo "Connected to $(hostname)"
            whoami
            uptime
